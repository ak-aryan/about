# Sourcegraph monitoring architecture

**Note:** Looking for _how to monitor Sourcegraph?_ See the [observability documentation](https://docs.sourcegraph.com/admin/observability).

**Note:** Looking for _how to develop Sourcegraph monitoring?_ See the [monitoring developer guide](monitoring.md).

This document describes the architecture of Sourcegraph's monitoring stack, and the technical decisions we have made to date and why.

<!-- generated from monitoring_architecture.excalidraw -->
![architecture diagram](https://storage.googleapis.com/sourcegraph-assets/monitoring-architecture.png)

## Long-term vision

To better understand our goals with Sourcegraph's monitoring stack, please read [monitoring pillars: long-term vision](monitoring_pillars.md#long-term-vision).

## Monitoring generator

We use a custom [declarative Go generator syntax](https://sourcegraph.com/github.com/sourcegraph/sourcegraph/-/tree/monitoring) for:

- Defining the services we monitor.
- Describing _what those services do_ to site admins.
- Laying out dashboards in a uniform, consistent, and simple way.
- Generating the [Prometheus alerting rules](#alerting) and Grafana dashboards.
- Generating documentation in the form of ["possible solutions"](https://docs.sourcegraph.com/admin/observability/alert_solutions) for site admins to follow when alerts are firing.

This allows us to assert constraints and principles that we want to hold ourselves to, as described in [our monitoring pillars](monitoring_pillars.md).

To learn more about adding monitoring using the generator, see ["How easy is it to add monitoring?"](monitoring.md#how-easy-is-it-to-add-monitoring)

## Sourcegraph deployment

### Sourcegraph Grafana

We use [Grafana](https://grafana.com) for:

- Displaying generated dashboards for our Prometheus metrics and alerts.
- Providing an interface to query Prometheus metrics and Jaeger traces.

The [`sourcegraph/grafana`](https://github.com/sourcegraph/sourcegraph/tree/master/docker-images/grafana) image handles shipping Grafana and Sourcegraph monitoring dashboards. It bundles:

* Preconfigured [Grafana](https://grafana.com), which displays data from Prometheus and Jaeger
* Dashboards generated by the [monitoring generator](#monitoring-generator).

#### Admin reverse-proxy

For convenience, Grafana is served on `/-/debug/grafana` on all Sourcegraph deployments via a reverse-proxy restricted to admins.

Services served via reverse-proxy in this manner could be vulnerable to [cross-site request forgery](https://owasp.org/www-community/attacks/csrf), which is complicated to resolve ([#6075](https://github.com/sourcegraph/sourcegraph/issues/6075)). This means that at the moment, making changes to Grafana using the Grafana UI is not possible without setting up a port-forward, something [we want to avoid asking customers to do](monitoring_pillars.md#long-term-vision). In addition, provisioned dashboards generated by the [monitoring generator](#monitoring-generator) cannot be edited at all.

### Sourcegraph Prometheus

We use [Prometheus](https://prometheus.io) for:

- Collecting high-level, and low-cardinality, metrics from our services.
- Defining Sourcegraph alerts as both:
  - Prometheus recording rules, [`alert_count`](#alert-count-metrics).
  - Prometheus alert rules (which trigger [notifications](#alert-notifications)) based on `alert_count` metrics.

The [`sourcegraph/prometheus`](https://github.com/sourcegraph/sourcegraph/tree/master/docker-images/prometheus) image handles shipping Sourcegraph metrics and alerting. It bundles:

* Preconfigured [Prometheus](https://prometheus.io), which consumes metrics from Sourcegraph services.
* Alert and recording rules generated by the [monitoring generator](#monitoring-generator).
* [Alertmanager](https://prometheus.io/docs/alerting/latest/alertmanager/), which handles alerts from Prometheus.
* [prom-wrapper](https://github.com/sourcegraph/sourcegraph/tree/master/docker-images/prometheus/cmd/prom-wrapper), which subscribes to updates in [site configuration](https://docs.sourcegraph.com/admin/config/site_config) and propagates relevant settings to Alertmanager configuration.

#### Alert count metrics

`alert_count` metrics are special Prometheus recording rules that evaluate a single upper or lower bound, as defined in an [Observable](https://sourcegraph.com/search?q=repo:%5Egithub%5C.com/sourcegraph/sourcegraph%24+file:generator.go+type+Observable+struct+%7B:%5Bdef%5D%7D&patternType=structural) and generated by the [monitoring generator](#monitoring-generator). This metric is always either 0 if the threshold is not exceeded (or data does not exist, if configured), or 1 if the threshold is exceeded. This allows historical alert data to easily be [consumed programmatically](https://docs.sourcegraph.com/admin/observability/alerting_custom_consumption).

Learn more about the `alert_count` metrics in the [metrics guide](https://docs.sourcegraph.com/admin/observability/metrics_guide#alert-count).

*Rationale for `alert_count`*: TODO(@slimsag)

#### Alert notifications

We use [Alertmanager](https://prometheus.io/docs/alerting/latest/alertmanager/) for:

- Providing data about currently active Sourcegraph alerts.
- Routing alerts to appropriate receivers and silencing them when desired, [configured using site configuration](#alert-notifications).

Alertmanager is bundled in `sourcegraph/prometheus`, and notifications are configured for Sourcegraph alerts [using site configuration](https://docs.sourcegraph.com/admin/observability/alerting). This functionality is provided by the [prom-wrapper](#prom-wrapper).

*Rationale for notifiers in site configuration*: Due to the limitations of [admin reverse-proxies](#admin-reverse-proxy), alerts cannot be configured without port-forwarding or custom ConfigMaps, something we [want to avoid](monitoring_pillars.md#long-term-vision).

*Rationale for Alertmanager*: An approach for notifiers using Grafana was considered, but had some issues outlined in [#11832](https://github.com/sourcegraph/sourcegraph/pull/11832), so Alertmanager was selected as our notification provider.

*Rationale for silencing in site configuration*: Similar to the [Grafana admin reverse-proxy](#admin-reverse-proxy), silencing using the Alertmanager UI would require port-forwarding, something we [want to avoid](monitoring_pillars.md#long-term-vision).

#### prom-wrapper

The [prom-wrapper](https://github.com/sourcegraph/sourcegraph/tree/master/docker-images/prometheus/cmd/prom-wrapper) is the entrypoint program for `sourcegraph/prometheus` and it:

* Handles starting up Prometheus and Alertmanager
* Applies updates to site configuration by [generating a diff and applying changes](https://sourcegraph.com/search?q=repo:%5Egithub.com/sourcegraph/sourcegraph%24+file:docker-images/prometheus+type:symbol+Change+OR+Diff&patternType=literal)
  * Most notably, this includes [configuring notifiers and silences](#alert-notifications) for Sourcegraph alerts
* Exposes [endpoints for configuration issues, alerts summary statuses, and reverse-proxies Prometheus and Alertmanager](https://sourcegraph.com/search?q=repo:%5Egithub.com/sourcegraph/sourcegraph%24+file:docker-images/prometheus+PathPrefix%28:%5Bpath%5D%29.Handler%28:%5Bhandler%5D%29&patternType=structural)

## Custom additions

TODO: how we handle out-of-band metrics, alerts (things we don't ship to customers)

## Sourcegraph Cloud

This section describes how our monitoring stack is used in Sourcegraph Cloud and what customizations we have made.

### Alerts

Notifiers for alerts are configured via the [`deploy-sourcegraph-dot-com` frontend ConfigMap for `site.json`](https://github.com/sourcegraph/deploy-sourcegraph-dot-com/blob/release/base/frontend/sourcegraph-frontend.ConfigMap.yaml#L5188-L5274).

Alerts go to the [`#alerts`](https://sourcegraph.slack.com/archives/CSCFMFXS5)channel, with critical alerts going to [OpsGenie](https://about.sourcegraph.com/handbook/engineering/on_call).

### Blackbox exporter

TODO
